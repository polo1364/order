<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>便當點餐系統</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<style>
  body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 1em; background: #f9f9f9; }
  h2 { color: #b30000; margin-bottom: 0.5em; }
  table, th, td { border: 1px solid #ccc; border-collapse: collapse; padding: 4px 8px; background: #fff; }
  th { background: #eee; }
  .hidden { display: none; }
  .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; }
  .modal-content { background: #fff; padding: 1em; border-radius: 4px; max-width: 400px; width: 100%; }
  .modal-content h3 { margin-top: 0; }
</style>
</head>
<body>

<h2>便當點餐系統</h2>

<!-- 提醒視窗 -->
<div id="reminderModal" class="modal">
  <div class="modal-content">
    <h3>下週店家提醒</h3>
    <div id="reminderBody"></div>
    <button id="saveReminder">儲存</button>
  </div>
</div>

<h3>下週店家與菜單</h3>
<div id="reminderStores"></div>

<script>
const reminderDays = ['星期一', '星期二', '星期三', '星期四', '星期五'];

// 生成下拉式提醒視窗
window.onload = async () => {
  const reminderBody = document.getElementById('reminderBody');
  let storesData = {};
  try {
    const res = await fetch("menu.json");
    storesData = await res.json();
  } catch {
    alert("無法載入菜單資料！");
    return;
  }

  const today = new Date();
  const nextMonday = new Date(today);
  nextMonday.setDate(today.getDate() + ((8 - today.getDay()) % 7 || 7));

  reminderDays.forEach((day, i) => {
    const date = new Date(nextMonday);
    date.setDate(date.getDate() + i);
    const dateStr = date.toISOString().split('T')[0];
    const select = document.createElement('select');
    select.setAttribute('data-date', dateStr);
    select.innerHTML = `<option value="">請選擇</option>`;
    Object.keys(storesData).forEach(store => {
      select.innerHTML += `<option value="${store}">${store}</option>`;
    });
    const div = document.createElement('div');
    div.innerHTML = `<strong>${dateStr}（${day}）</strong>: `;
    div.appendChild(select);
    reminderBody.appendChild(div);
  });

  renderReminderStores(); // 初始化顯示
};

// 儲存提醒資料
document.getElementById('saveReminder').onclick = () => {
  const selects = document.querySelectorAll('#reminderBody select');
  const data = {};
  selects.forEach(sel => {
    const date = sel.getAttribute('data-date');
    const store = sel.value;
    if (store) data[date] = store;
  });
  localStorage.setItem('reminderData', JSON.stringify(data));
  alert('已儲存提醒資料！');
  document.getElementById('reminderModal').style.display = 'none';
  renderReminderStores(); // 更新主頁
};

// 渲染主頁下週店家
async function renderReminderStores() {
  const container = document.getElementById('reminderStores');
  container.innerHTML = '';
  const data = JSON.parse(localStorage.getItem('reminderData')) || {};

  let storesData = {};
  try {
    const res = await fetch("menu.json");
    storesData = await res.json();
  } catch {
    alert("無法載入菜單資料！");
    return;
  }

  Object.entries(data).forEach(([date, store]) => {
    const div = document.createElement('div');
    div.style.marginBottom = '0.5em';
    div.innerHTML = `<strong>${date}</strong> - ${store} 
      <button onclick='toggleMenu("${store}", this)'>顯示菜單</button>
      <div id='menu-${store}' class='hidden'></div>`;
    container.appendChild(div);
  });
}

// 顯示或隱藏菜單
async function toggleMenu(store, btn) {
  const menuDiv = document.getElementById(`menu-${store}`);
  if (!menuDiv.classList.contains('hidden')) {
    menuDiv.classList.add('hidden');
    btn.textContent = '顯示菜單';
    return;
  }

  let storesData = {};
  try {
    const res = await fetch("menu.json");
    storesData = await res.json();
  } catch {
    alert("無法載入菜單資料！");
    return;
  }

  const menu = storesData[store];
  let html = "<table><tr><th>品項</th><th>價格</th></tr>";
  for (let item in menu) {
    if (typeof menu[item] === 'object') {
      for (let sub in menu[item]) {
        html += `<tr><td>${item}（${sub}）</td><td>$${menu[item][sub]}</td></tr>`;
      }
    } else {
      html += `<tr><td>${item}</td><td>$${menu[item]}</td></tr>`;
    }
  }
  html += "</table>";

  menuDiv.innerHTML = html;
  menuDiv.classList.remove('hidden');
  btn.textContent = '隱藏菜單';
}
</script>

</body>
</html>