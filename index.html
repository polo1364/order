<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>ä¾¿ç•¶é»é¤ç³»çµ±</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<style>
  body {
    font-family: sans-serif;
    color: #333;
    max-width: 800px;
    margin: auto;
    padding: 1em;
    background: url('https://raw.githubusercontent.com/polo1364/order/refs/heads/main/FB5BBC50-D21A-4F57-AF32-ABE798E3ABA1.png') repeat;
    background-size: 200px 200px;
    position: relative;
  }
  body::before {
    content: "";
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(255, 255, 255, 0.7);
    pointer-events: none;
    z-index: 0;
  }
  #main, #reminder, #orders, h2, h3, table, th, td {
    position: relative;
    z-index: 1;
  }
  h2 {
    color: #b30000;
    margin-bottom: 0.5em;
  }
  table, th, td {
    border: 1px solid #ccc;
    border-collapse: collapse;
    padding: 4px 8px;
    background: #fff;
  }
  th {
    background: #eee;
  }
  .hidden { display: none; }
  .section {
    margin-bottom: 1em;
    border: 1px solid #ccc;
    padding: 0.5em;
    background: #fff;
    border-radius: 4px;
  }

  /* ğŸ”¥ æ–°å¢: æŠŠã€Œåˆªé™¤ã€å’Œã€Œé¡¯ç¤ºèœå–®ã€æŒ‰éˆ•é¡å¤–æŒ‡å®š classï¼Œæ–¹ä¾¿çµ±ä¸€éš±è— */
  .delete-btn, .print-btn, .toggle-btn {
    display: inline-block;
  }

  /* ğŸ–¨ï¸ åˆ—å°æ™‚ï¼Œå®Œå…¨éš±è—äº’å‹•å…ƒç´  */
  @media print {
    html, body {
      margin: 0;
      padding: 0;
      background: #fff !important;
    }
    button, input, select {
      display: none !important;
      visibility: hidden !important;
    }
    .delete-btn, .print-btn, .toggle-btn, .reminder-select {
      display: none !important;
      visibility: hidden !important;
    }
    .section { page-break-after: always; }
  }
</style>
</head>
<body>

<h2>ä¾¿ç•¶é»é¤ç³»çµ±</h2>

<div id="reminder">
  <h3>æœ¬é€±ä¾¿ç•¶</h3>
  <div id="thisWeekSelects"></div>

  <h3>ä¸‹é€±ä¾¿ç•¶</h3>
  <div id="nextWeekSelects"></div>
  <button onclick="saveNextWeekReminder()">å„²å­˜æé†’è¨­å®š</button>
</div>

<div id="orders"></div>

<script>
const firebaseConfig = { databaseURL: "https://bento-5bb36-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let storeList = [];
let thisWeekReminder = {};
let nextWeekReminder = {};

async function loadStores() {
  const res = await fetch("menu.json");
  const data = await res.json();
  storeList = Object.keys(data);
}

// æª¢æŸ¥æ˜¯å¦è¦æ¸…é™¤æœ¬é€±æé†’
async function clearThisWeekReminderIfNeeded() {
  const today = new Date();
  if (today.getDay() === 1) {
    await db.ref('reminder/thisWeek').remove();
    console.log("å·²æ¸…é™¤æœ¬é€±æé†’");
  }
}

// è¼‰å…¥æé†’è¨­å®š
async function loadReminder() {
  const snapThis = await db.ref('reminder/thisWeek').once('value');
  thisWeekReminder = snapThis.val() || { ä¸€: "", äºŒ: "", ä¸‰: "", å››: "", äº”: "" };
  const snapNext = await db.ref('reminder/nextWeek').once('value');
  nextWeekReminder = snapNext.val() || { ä¸€: "", äºŒ: "", ä¸‰: "", å››: "", äº”: "" };

  renderReminder();
}

function renderReminder() {
  const days = ["ä¸€", "äºŒ", "ä¸‰", "å››", "äº”"];
  let htmlThis = "", htmlNext = "";
  days.forEach(d => {
    htmlThis += `<div>æ˜ŸæœŸ${d}ï¼š<select disabled><option>${thisWeekReminder[d] || "æœªè¨­å®š"}</option></select></div>`;
    htmlNext += `<div>æ˜ŸæœŸ${d}ï¼š
      <select id="dayNext_${d}">
        <option value="">è«‹é¸æ“‡</option>
        ${storeList.map(s => `<option value="${s}" ${nextWeekReminder[d] === s ? "selected" : ""}>${s}</option>`).join("")}
      </select></div>`;
  });
  document.getElementById('thisWeekSelects').innerHTML = htmlThis;
  document.getElementById('nextWeekSelects').innerHTML = htmlNext;
}

function saveNextWeekReminder() {
  const days = ["ä¸€", "äºŒ", "ä¸‰", "å››", "äº”"];
  const newReminder = {};
  days.forEach(d => {
    const val = document.getElementById(`dayNext_${d}`).value;
    newReminder[d] = val;
  });
  db.ref('reminder/nextWeek').set(newReminder);
  nextWeekReminder = newReminder;
  alert("å·²å„²å­˜ä¸‹é€±æé†’è¨­å®šï¼");
  renderOrders();
}

async function renderOrders() {
  document.getElementById('orders').innerHTML = '';
  const res = await fetch("menu.json");
  const menuData = await res.json();
  const today = new Date();
  const nextMonday = new Date(today);
  nextMonday.setDate(today.getDate() + (8 - today.getDay()));
  const days = ["ä¸€", "äºŒ", "ä¸‰", "å››", "äº”"];
  for (let idx = 0; idx < days.length; idx++) {
    const d = days[idx];
    const date = new Date(nextMonday);
    date.setDate(date.getDate() + idx);
    const yyyyMMdd = date.toISOString().split('T')[0];
    const store = nextWeekReminder[d] || "æœªè¨­å®š";
    if (store === "æœªè¨­å®š") continue;

    const section = document.createElement('div');
    section.className = 'section';
    section.innerHTML = `<h4>${yyyyMMdd}ï¼ˆæ˜ŸæœŸ${d}ï¼‰ï¼š${store}
      <button onclick="toggleMenu('${yyyyMMdd}')">é¡¯ç¤º/éš±è—èœå–®</button></h4>
      <div id="menu_${yyyyMMdd}" style="display:none;"></div>
      <div id="stats_${yyyyMMdd}"></div>`;
    document.getElementById('orders').appendChild(section);

    const menuDiv = document.getElementById(`menu_${yyyyMMdd}`);
    let html = "<table><tr><th>å“é …</th><th>åƒ¹æ ¼</th><th>å‚™è¨»</th><th>é¸å–</th></tr>";
    const menu = menuData[store];
    for (let item in menu) {
      const price = menu[item];
      if (typeof price === 'object') {
        for (let sub in price) {
          html += `<tr><td>${item}ï¼ˆ${sub}ï¼‰</td><td>${price[sub]}</td>
            <td><input type='text' placeholder='å‚™è¨»'></td>
            <td><input type='radio' name='menu_${yyyyMMdd}' value='${item}-${sub}' data-price='${price[sub]}'></td></tr>`;
        }
      } else {
        html += `<tr><td>${item}</td><td>${price}</td>
          <td><input type='text' placeholder='å‚™è¨»'></td>
          <td><input type='radio' name='menu_${yyyyMMdd}' value='${item}' data-price='${price}'></td></tr>`;
      }
    }
    html += `</table>
      <input type="text" id="user_${yyyyMMdd}" placeholder="è¼¸å…¥å§“å/å·¥è™Ÿ" />
      <button onclick='submitOrder("${yyyyMMdd}","${store}")'>é€å‡º</button>`;
    menuDiv.innerHTML = html;

    db.ref('orders/' + yyyyMMdd).on('value', snap => {
      const data = snap.val();
      const statsDiv = document.getElementById(`stats_${yyyyMMdd}`);
      if (!data) { statsDiv.innerHTML = 'å°šç„¡è³‡æ–™'; return; }
      let table = "<table><tr><th>å“é …</th><th>äººå“¡</th><th>æ•¸é‡</th><th>å–®åƒ¹</th><th>å°è¨ˆ</th></tr>";
      let total = 0, paidTotal = 0, unpaidTotal = 0;
      const byItem = {};
      for (let id in data) {
        const { user, item, price, note = "", paid = false } = data[id];
        const [itemName, size] = item.split("-");
        const displayItem = size ? `${itemName}ï¼ˆ${size}ï¼‰` : itemName;
        if (!byItem[displayItem]) byItem[displayItem] = [];
        byItem[displayItem].push({ user, id, price, note, paid });
      }
      for (let item in byItem) {
        const users = byItem[item];
        const unitPrice = parseInt(users[0].price);
        const itemCount = users.length;
        let itemTotal = 0;
        users.forEach(u => {
          const extraMatch = u.note.match(/åŠ (\d+)å…ƒ/);
          const extra = extraMatch ? parseInt(extraMatch[1]) : 0;
          const finalPrice = unitPrice + extra;
          itemTotal += finalPrice;
          if (u.paid) paidTotal += finalPrice;
          else unpaidTotal += finalPrice;
        });
        total += itemTotal;
        const priceCell = `$${unitPrice}<br><span style="font-size: 0.8em; color: #555;">ï¼ˆå…± ${itemCount} ä»½ï¼‰</span>`;
        const userCells = users.map(u => {
          const paidCk = `<input type='checkbox' ${u.paid ? "checked" : ""} onclick='togglePaid("${yyyyMMdd}","${u.id}", this.checked)'>`;
          const delBtn = `<button onclick='deleteOrder("${yyyyMMdd}","${u.id}")'>åˆªé™¤</button>`;
          return `<div>${u.user}${u.note ? `ï¼ˆ${u.note}ï¼‰` : ""} ${paidCk} ${delBtn}</div>`;
        }).join("");
        table += `<tr><td>${item}</td><td>${userCells}</td><td>${itemCount}</td><td>${priceCell}</td><td>$${itemTotal}</td></tr>`;
      }
      table += `<tr><td colspan="5">ç¸½é‡‘é¡ï¼š$${total} ï½œ å·²ä»˜æ¬¾ï¼š$${paidTotal} ï½œ æœªä»˜æ¬¾ï¼š$${unpaidTotal}</td></tr></table>
        <button onclick='printSection("stats_${yyyyMMdd}")'>åˆ—å°çµ±è¨ˆè¡¨</button>`;
      statsDiv.innerHTML = table;
    });
  }
}

function toggleMenu(date) {
  const div = document.getElementById(`menu_${date}`);
  div.style.display = div.style.display === "none" ? "block" : "none";
}

function submitOrder(date, store) {
  const sel = document.querySelector(`input[name='menu_${date}']:checked`);
  const user = document.getElementById(`user_${date}`).value.trim();
  const noteInput = sel ? sel.parentNode.previousElementSibling.firstElementChild.value.trim() : "";
  if (!user || !store || !sel) return alert("è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ï¼");
  const item = sel.value;
  const price = sel.getAttribute('data-price');
  const note = noteInput || "";
  const key = db.ref('orders/' + date).push().key;
  db.ref('orders/' + date + '/' + key).set({ user, item, price, note, store });
  alert("å·²é€å‡ºï¼");
}

function togglePaid(date, id, checked) { db.ref(`orders/${date}/${id}`).update({ paid: checked }); }
function deleteOrder(date, id) { if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) db.ref(`orders/${date}/${id}`).remove(); }
function printSection(id) {
  const statsDiv = document.getElementById(id);
  const cleanHtml = statsDiv.querySelector("table").outerHTML;
  const sectionHeader = statsDiv.parentElement.querySelector("h4").outerHTML;
  const win = window.open('', '', 'width=800,height=600');
  win.document.write('<html><head><title>åˆ—å°çµ±è¨ˆè¡¨</title>');
  win.document.write('<style>body { font-family: sans-serif; } h4 { margin-bottom: 0.5em; } table, th, td { border: 1px solid #ccc; border-collapse: collapse; padding: 4px 8px; } th { background: #eee; }</style>');
  win.document.write('</head><body>');
  win.document.write(sectionHeader + cleanHtml);
  win.document.write('</body></html>');
  win.document.close();
  win.print();
}

// åˆå§‹åŒ–
(async function() {
  await loadStores();
  await clearThisWeekReminderIfNeeded();
  await loadReminder();
  await renderOrders();
})();
</script>
</body>
</html>