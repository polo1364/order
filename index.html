<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>便當點餐系統</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<style>
  body {
    font-family: sans-serif;
    color: #000;
    max-width: 800px;
    margin: auto;
    padding: 1em;
    background: url('https://raw.githubusercontent.com/polo1364/order/refs/heads/main/FB5BBC50-D21A-4F57-AF32-ABE798E3ABA1.png') repeat;
    background-size: 200px 200px;
  }
  #reminder, #orders, .section {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 4px;
    padding: 1em;
    margin-bottom: 1em;
  }
  h2 { color: #b30000; margin-bottom: 0.5em; }
  table, th, td {
    border: 1px solid #ccc;
    border-collapse: collapse;
    padding: 4px 8px;
    background: rgba(255, 255, 255, 0.95);
  }
  th { background: #eee; }
  .action-btn { display: inline-block; }
  @media print {
    html, body { background: #fff !important; }
    button, input, select {
      display: none !important;
      visibility: hidden !important;
    }
    .section { page-break-after: always; }
  }
</style>
</head>
<body>

<h2>便當點餐系統</h2>

<div id="reminder">
  <h3>本週便當</h3>
  <div id="thisWeekSelects"></div>
  <h3>下週便當</h3>
  <div id="nextWeekSelects"></div>
  <button class="action-btn" onclick="saveNextWeekReminder()">儲存提醒設定</button>
</div>

<div id="orders"></div>

<script>
const firebaseConfig = { databaseURL: "https://bento-5bb36-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let storeList = [];
let thisWeekReminder = {};
let nextWeekReminder = {};

async function loadStores() {
  const res = await fetch("menu.json");
  const data = await res.json();
  storeList = Object.keys(data);
  return data;
}

async function loadReminder() {
  const snapThis = await db.ref('reminder/thisWeek').once('value');
  thisWeekReminder = snapThis.val() || { 一: "", 二: "", 三: "", 四: "", 五: "" };
  const snapNext = await db.ref('reminder/nextWeek').once('value');
  nextWeekReminder = snapNext.val() || { 一: "", 二: "", 三: "", 四: "", 五: "" };
  renderReminder();
}

function renderReminder() {
  const days = ["一", "二", "三", "四", "五"];
  let htmlThis = "", htmlNext = "";
  days.forEach(d => {
    htmlThis += `<div>星期${d}：<select disabled><option>${thisWeekReminder[d] || "未設定"}</option></select></div>`;
    htmlNext += `<div>星期${d}：
      <select id="dayNext_${d}">
        <option value="">請選擇</option>
        ${storeList.map(s => `<option value="${s}" ${nextWeekReminder[d] === s ? "selected" : ""}>${s}</option>`).join("")}
      </select></div>`;
  });
  document.getElementById('thisWeekSelects').innerHTML = htmlThis;
  document.getElementById('nextWeekSelects').innerHTML = htmlNext;
}

function saveNextWeekReminder() {
  const days = ["一", "二", "三", "四", "五"];
  const newReminder = {};
  days.forEach(d => {
    const val = document.getElementById(`dayNext_${d}`).value;
    newReminder[d] = val;
  });
  db.ref('reminder/nextWeek').set(newReminder);
  nextWeekReminder = newReminder;
  alert("已儲存下週提醒設定！");
  renderOrders();
}

async function renderOrders() {
  document.getElementById('orders').innerHTML = '';
  const menuData = await loadStores();
  const today = new Date();
  const nextMonday = new Date(today);
  nextMonday.setDate(today.getDate() + (8 - today.getDay()));
  const days = ["一", "二", "三", "四", "五"];

  for (let idx = 0; idx < days.length; idx++) {
    const d = days[idx];
    const date = new Date(nextMonday);
    date.setDate(date.getDate() + idx);
    const yyyyMMdd = date.toISOString().split('T')[0];
    const store = nextWeekReminder[d] || "未設定";
    if (store === "未設定") continue;

    const section = document.createElement('div');
    section.className = 'section';
    section.innerHTML = `<h4>${yyyyMMdd}（星期${d}）：${store}
      <button class="action-btn" onclick="toggleMenu('${yyyyMMdd}')">顯示/隱藏菜單</button></h4>
      <div id="menu_${yyyyMMdd}" style="display:none;"></div>
      <div id="stats_${yyyyMMdd}"></div>`;
    document.getElementById('orders').appendChild(section);

    // ✅ 產生菜單
    const menuDiv = document.getElementById(`menu_${yyyyMMdd}`);
    const menu = menuData[store];
    if (menu) {
      let html = "<table><tr><th>品項</th><th>價格</th></tr>";
      for (let item in menu) {
        const price = menu[item];
        if (typeof price === 'object') {
          for (let sub in price) {
            html += `<tr><td>${item}（${sub}）</td><td>${price[sub]}</td></tr>`;
          }
        } else {
          html += `<tr><td>${item}</td><td>${price}</td></tr>`;
        }
      }
      html += "</table>";
      menuDiv.innerHTML = html;
    } else {
      menuDiv.innerHTML = "查無菜單";
    }

    // ✅ 產生統計表（略，可依你原本的統計生成程式碼）
    db.ref('orders/' + yyyyMMdd).on('value', snap => {
      const data = snap.val();
      const statsDiv = document.getElementById(`stats_${yyyyMMdd}`);
      if (!data) { statsDiv.innerHTML = '尚無資料'; return; }
      // 你的統計表邏輯放在這裡...
      statsDiv.innerHTML = '統計資料尚未生成（示範）';
    });
  }
}

function toggleMenu(date) {
  const div = document.getElementById(`menu_${date}`);
  div.style.display = div.style.display === "none" ? "block" : "none";
}

(async function() {
  await loadStores();
  await loadReminder();
  await renderOrders();
})();
</script>
</body>
</html>