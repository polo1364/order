<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>便當統計系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      margin: 0;
      padding: 0;
      background: #f9f9f9;
    }
    .container {
      max-width: 1000px;
      margin: auto;
      padding: 1em;
    }
    .section {
      background: #fff;
      padding: 1em;
      border-radius: 6px;
      margin-bottom: 1em;
      box-shadow: 0 0 6px rgba(0,0,0,0.05);
    }
    h2, #currentStoreName {
      color: #b30000;
      text-align: center;
      margin-top: 0;
    }
    table {
      width: 100%;
      overflow-x: auto;
      display: block;
    }
    table, th, td {
      border: 1px solid #ccc;
      border-collapse: collapse;
      padding: 6px 8px;
      text-align: center;
      background: #fff;
      font-size: 14px;
    }
    th {
      background: #eee;
    }
    input[type=number], select {
      width: 100%;
      padding: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    select#selectStore {
      width: auto;
      min-width: 150px;
      max-width: 100%;
    }
    button {
      font-size: 14px;
      padding: 8px 16px;
      margin: 6px;
      width: 100%;
      max-width: 200px;
    }
    .print-footer {
      display: none;
      margin-top: 40px;
      font-size: 18px;
      line-height: 1.8;
      text-align: center;
    }
    @media (min-width: 768px) {
      input[type=number], select {
        width: 60px;
      }
      select#selectStore {
        width: auto;
        min-width: 200px;
      }
      button {
        width: auto;
      }
    }
    @media print {
      .menu-table, input, button, select, .section label {
        display: none !important;
      }
      .print-footer, #currentStoreName {
        display: block !important;
      }
      html, body {
        margin: 0;
        padding: 0;
        width: 210mm;
        height: 297mm;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>便當點餐系統</h2>
    <div class="section">
      <label>選擇店家：
        <select id="selectStore" onchange="loadStoreMenu()"></select>
      </label>
    </div>
    <h3 id="currentStoreName" style="display:none;"></h3>
    <div id="orders" class="section" style="display:none;">
      <div class="menu-table" id="menuArea"></div>
      <div id="statsArea"></div>
      <div style="text-align:center;">
        <button onclick="printStats()">列印統計表</button>
        <button onclick="clearData()">清除紀錄</button>
      </div>
    </div>
  </div>
  <div class="print-footer">
    <div id="printStoreName"></div>
    <div>大瑞科技</div>
    <div>地址:高雄市大寮區鳳林二路532號</div>
    <div>電話:(07)7871875</div>
  </div>
<script>
let menuData = {};
let currentStore = "";
let currentAddonPrice = { rice: 0, noodle: 0, spicy: 0, bigBowl: 0 };
let hideBigBowl = false;
const extraMainOptions = {
  "品馨肉羹": {
    enable: true,
    label: "加主食",
    price: 10,
    options: ["飯", "麵", "米粉", "粄條"]
  }
};

fetch('menu.json')
  .then(response => response.json())
  .then(data => {
    menuData = data;
    loadStores();
  })
  .catch(error => console.error('載入 menu.json 失敗', error));

function loadStores() {
  const select = document.getElementById('selectStore');
  select.innerHTML = '<option value="">請選擇</option>';
  for (let store in menuData) {
    const opt = document.createElement('option');
    opt.value = store;
    opt.textContent = store;
    select.appendChild(opt);
  }
}

function loadStoreMenu() {
  const store = document.getElementById('selectStore').value;
  currentStore = store;
  document.getElementById('currentStoreName').style.display = 'block';
  document.getElementById('currentStoreName').textContent = store;
  document.getElementById('printStoreName').textContent = store;
  document.getElementById('orders').style.display = 'block';
  const menuArea = document.getElementById('menuArea');
  const storeData = menuData[store];
  currentAddonPrice = storeData.addonPrice || {};
  hideBigBowl = !Object.values(storeData.menu).some(i => typeof i === 'object');
  let html = '<table><tr><th>品項</th><th>單價</th><th>數量</th><th>少飯</th><th>加飯</th><th>加麵</th><th>加辣</th><th>加大</th>';
  if (extraMainOptions[store]?.enable) html += '<th>' + extraMainOptions[store].label + '</th>';
  html += '</tr>';
  for (let item in storeData.menu) {
    const val = storeData.menu[item];
    if (typeof val === 'number') {
      html += renderRow(item, item, val, {});
    } else {
      for (let size in val) {
        const key = `${item}(${size})`;
        html += renderRow(key, key, val[size], {});
      }
    }
  }
  html += '</table>';
  menuArea.innerHTML = html;
  renderStats();
}

function renderRow(key, label, price, entry) {
  return `<tr>
    <td>${label}</td>
    <td>${price}</td>
    <td><input type='number' min='0' value='${entry.qty || 0}' onchange='update("${key}", ${price})' id='qty_${key}'></td>
    <td><input type='number' min='0' value='${entry.lessRice || 0}' onchange='update("${key}", ${price})' id='lessRice_${key}'></td>
    <td><input type='number' min='0' value='${entry.rice || 0}' onchange='update("${key}", ${price})' id='rice_${key}'></td>
    <td><input type='number' min='0' value='${entry.noodle || 0}' onchange='update("${key}", ${price})' id='noodle_${key}'></td>
    <td><input type='number' min='0' value='${entry.spicy || 0}' onchange='update("${key}", ${price})' id='spicy_${key}'></td>
    ${!hideBigBowl ? `<td><input type='number' min='0' value='${entry.bigBowl || 0}' onchange='update("${key}", ${price})' id='bigBowl_${key}'></td>` : "<td></td>"}
    ${extraMainOptions[currentStore]?.enable ?
      `<td>
        <select onchange='update("${key}", ${price})' id='extraMain_${key}'>
          <option value=''>無</option>
          ${extraMainOptions[currentStore].options.map(opt => `<option value='${opt}' ${entry.extraMain === opt ? "selected" : ""}>${opt}</option>`).join("")}
        </select>
        <input type='number' min='0' value='${entry.extraQty || 0}' onchange='update("${key}", ${price})' id='extraQty_${key}' />
      </td>` : ""}
  </tr>`;
}

function update(key, price) {
  const qty = parseInt(document.getElementById(`qty_${key}`)?.value || 0);
  const lessRice = parseInt(document.getElementById(`lessRice_${key}`)?.value || 0);
  const rice = parseInt(document.getElementById(`rice_${key}`)?.value || 0);
  const noodle = parseInt(document.getElementById(`noodle_${key}`)?.value || 0);
  const spicy = parseInt(document.getElementById(`spicy_${key}`)?.value || 0);
  const bigBowl = hideBigBowl ? 0 : parseInt(document.getElementById(`bigBowl_${key}`)?.value || 0);
  const extraMain = document.getElementById(`extraMain_${key}`)?.value || "";
  const extraQty = parseInt(document.getElementById(`extraQty_${key}`)?.value || 0);

  let data = loadLocal();
  if (qty === 0 && rice === 0 && noodle === 0 && spicy === 0 && bigBowl === 0 && lessRice === 0 && extraMain === "" && extraQty === 0) {
    delete data[key];
  } else {
    data[key] = { qty, rice, noodle, spicy, bigBowl, lessRice, extraMain, extraQty, price };
  }
  localStorage.setItem("bento_data", JSON.stringify(data));
  renderStats();
}

function renderStats() {
  const data = loadLocal();
  const statsDiv = document.getElementById("statsArea");
  if (!data || Object.keys(data).length === 0) {
    statsDiv.innerHTML = "尚無資料";
    return;
  }

  let total = 0;
  let table = "<table><tr><th>品項</th><th>數量</th><th>單價</th><th>備註</th><th>小計</th></tr>";

  for (let item in data) {
    const { price, qty, rice, noodle, spicy, bigBowl = 0, lessRice = 0, extraMain = "", extraQty = 0 } = data[item];
    const riceCost = rice * currentAddonPrice.rice;
    const noodleCost = noodle * currentAddonPrice.noodle;
    const spicyCost = spicy * currentAddonPrice.spicy;
    const bigBowlCost = bigBowl * (currentAddonPrice.bigBowl || 0);
    const extraMainCost = extraMain && extraQty > 0 && extraMainOptions[currentStore]?.price ? extraQty * extraMainOptions[currentStore].price : 0;

    const itemSubtotal = qty * price + riceCost + noodleCost + spicyCost + bigBowlCost + extraMainCost;
    total += itemSubtotal;

    const addons = [];
    if (lessRice > 0) addons.push(`少飯 x${lessRice}`);
    if (rice > 0) addons.push(`加飯 x${rice}（$${riceCost}）`);
    if (noodle > 0) addons.push(`加麵 x${noodle}（$${noodleCost}）`);
    if (spicy > 0) addons.push(`加辣 x${spicy}（$${spicyCost}）`);
    if (bigBowl > 0) addons.push(`加大 x${bigBowl}（$${bigBowlCost}）`);
    if (extraMain && extraQty > 0) addons.push(`加${extraMain} x${extraQty}（$${extraMainCost}）`);

    table += `<tr>
      <td>${item}</td>
      <td>${qty}</td>
      <td>$${price}</td>
      <td>${addons.join("<br>") || "-"}</td>
      <td>$${itemSubtotal}</td>
    </tr>`;
  }
  table += `<tr><td colspan='5'>總金額：$${total}</td></tr></table>`;
  statsDiv.innerHTML = table;
}
</script>
</body>
</html>
