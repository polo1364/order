<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>便當點餐系統</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<style>
  body {
  font-family: sans-serif;
  color: #000; /* 純黑文字，清晰 */
  max-width: 800px;
  margin: auto;
  padding: 1em;
  background: url('https://raw.githubusercontent.com/polo1364/order/refs/heads/main/FB5BBC50-D21A-4F57-AF32-ABE798E3ABA1.png') repeat;
  background-size: 200px 200px;
  position: relative;
}

/* 不用再額外疊白層，直接讓「主要內容區」加背景色 */
#main, #reminder, #orders, .section {
  background: rgba(255, 255, 255, 0.8); /* 白色底，透明度 0.8 */
  border-radius: 4px; /* 可加圓角美化 */
  padding: 1em; /* 加點內距，避免字貼邊 */
}

h2 {
  color: #b30000;
  margin-bottom: 0.5em;
}
table, th, td {
  border: 1px solid #ccc;
  border-collapse: collapse;
  padding: 4px 8px;
  background: rgba(255, 255, 255, 0.9); /* 表格也加白底 */
}
  .action-btn { display: inline-block; }
  @media print {
    html, body { background: #fff !important; }
    button, input, select {
      display: none !important;
      visibility: hidden !important;
    }
    .section { page-break-after: always; }
  }
</style>
</head>
<body>

<h2>便當點餐系統</h2>

<div id="orders"></div>

<script>
const firebaseConfig = { databaseURL: "https://bento-5bb36-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

async function renderOrders() {
  document.getElementById('orders').innerHTML = '';
  const res = await fetch("menu.json");
  const menuData = await res.json();

  const today = new Date();
  const nextMonday = new Date(today);
  nextMonday.setDate(today.getDate() + (8 - today.getDay()));
  const days = ["一", "二", "三", "四", "五"];

  for (let idx = 0; idx < days.length; idx++) {
    const d = days[idx];
    const date = new Date(nextMonday);
    date.setDate(date.getDate() + idx);
    const yyyyMMdd = date.toISOString().split('T')[0];
    const store = "新香味（林園）"; // 假設範例，請自行修改

    const section = document.createElement('div');
    section.className = 'section';
    section.innerHTML = `<h4>${yyyyMMdd}（星期${d}）：${store}
      <button class="action-btn" onclick="toggleMenu('${yyyyMMdd}')">顯示/隱藏菜單</button></h4>
      <div id="menu_${yyyyMMdd}" style="display:none;"></div>
      <div id="stats_${yyyyMMdd}"></div>`;
    document.getElementById('orders').appendChild(section);

    db.ref('orders/' + yyyyMMdd).on('value', snap => {
      const data = snap.val();
      const statsDiv = document.getElementById(`stats_${yyyyMMdd}`);
      if (!data) { statsDiv.innerHTML = '尚無資料'; return; }

      let table = "<table><tr><th>品項</th><th>人員</th><th>數量</th><th>單價</th><th>小計</th></tr>";
      let total = 0, paidTotal = 0, unpaidTotal = 0;
      const byItem = {};
      for (let id in data) {
        const { user, item, price, note = "", paid = false } = data[id];
        const [itemName, size] = item.split("-");
        const displayItem = size ? `${itemName}（${size}）` : itemName;
        if (!byItem[displayItem]) byItem[displayItem] = [];
        byItem[displayItem].push({ user, id, price: parseInt(price) || 0, note, paid });
      }

      for (let item in byItem) {
        const users = byItem[item];
        const unitPrice = users[0].price;
        const itemCount = users.length;
        let itemTotal = 0;

        // 將人員備註排序、統計加價
        const sortedUsers = [...users].sort((a, b) => (b.note ? 1 : 0) - (a.note ? 1 : 0));
        const noteMap = {};
        sortedUsers.forEach(u => {
          const extraMatch = u.note.match(/加(\d+)元/);
          const extra = extraMatch ? parseInt(extraMatch[1]) : 0;
          const finalPrice = unitPrice + extra;
          itemTotal += finalPrice;
          if (u.paid) paidTotal += finalPrice;
          else unpaidTotal += finalPrice;

          const key = u.note || "（無備註）";
          if (!noteMap[key]) noteMap[key] = [];
          noteMap[key].push(u);
        });
        total += itemTotal;

        // 顯示人員，3 個一組
        const sortedNotes = Object.keys(noteMap).sort(a => a === "（無備註）" ? 1 : -1);
        const userCells = sortedNotes.map(note => {
          const userChunks = [];
          const usersInNote = noteMap[note];
          for (let i = 0; i < usersInNote.length; i += 3) {
            const chunk = usersInNote.slice(i, i + 3).map(u => {
              const paidCk = `<input type='checkbox' ${u.paid ? "checked" : ""} onclick='togglePaid("${yyyyMMdd}","${u.id}", this.checked)'>`;
              const delBtn = `<button class="action-btn" onclick='deleteOrder("${yyyyMMdd}","${u.id}")'>刪除</button>`;
              return `${u.user} ${paidCk} ${delBtn}`;
            }).join("、");
            userChunks.push(chunk);
          }
          return note === "（無備註）" ? userChunks.join("、") : `【${note}】：${userChunks.join("、")}`;
        }).join("<br>");

        const priceCell = `$${unitPrice}<br><span style="font-size: 0.8em; color: #555;">（共 ${itemCount} 份）</span>`;
        table += `<tr><td>${item}</td><td>${userCells}</td><td>${itemCount}</td><td>${priceCell}</td><td>$${itemTotal}</td></tr>`;
      }
      table += `<tr><td colspan="5">總金額：$${total} ｜ 已付款：$${paidTotal} ｜ 未付款：$${unpaidTotal}</td></tr></table>
        <button class="action-btn" onclick='printSection("stats_${yyyyMMdd}")'>列印統計表</button>`;
      statsDiv.innerHTML = table;
    });
  }
}

function toggleMenu(date) {
  const div = document.getElementById(`menu_${date}`);
  div.style.display = div.style.display === "none" ? "block" : "none";
}
function togglePaid(date, id, checked) { db.ref(`orders/${date}/${id}`).update({ paid: checked }); }
function deleteOrder(date, id) { if (confirm("確定刪除？")) db.ref(`orders/${date}/${id}`).remove(); }
function printSection(id) {
  const section = document.getElementById(id).parentElement;
  const interactiveElements = section.querySelectorAll('button, input, select');
  interactiveElements.forEach(el => { el.style.display = 'none'; });
  const win = window.open('', '', 'width=800,height=600');
  win.document.write('<html><head><title>列印統計表</title>');
  win.document.write('<style>body { font-family: sans-serif; } h4 { margin-bottom: 0.5em; } table, th, td { border: 1px solid #ccc; border-collapse: collapse; padding: 4px 8px; } th { background: #eee; }</style>');
  win.document.write('</head><body>');
  win.document.write(section.innerHTML);
  win.document.write('</body></html>');
  win.document.close();
  win.onload = () => {
    win.print();
    win.onafterprint = () => {
      win.close();
      interactiveElements.forEach(el => { el.style.display = ''; });
    };
  };
}

(async function() { await renderOrders(); })();
</script>
</body>
</html>