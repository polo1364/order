<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>便當點餐系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      margin: 0;
      padding: 0;
      background: #fdfdfd;
    }
    .container {
      max-width: 800px;
      margin: auto;
      padding: 1em;
    }
    .section {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 1em;
      margin-bottom: 1em;
    }
    h2 {
      color: #b30000;
      text-align: center;
    }
    table, th, td {
      border: 1px solid #ccc;
      border-collapse: collapse;
      padding: 4px 8px;
      background: #fff;
      width: 100%;
    }
    th { background: #eee; }
    input[type=number] { width: 60px; }
    .action-btn {
      margin-top: 10px;
      padding: 6px 10px;
    }
    @media print {
      input, button, select { display: none !important; }
      .section { page-break-after: always; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>便當點餐系統（本地即時儲存）</h2>

    <div class="section">
      <label>選擇日期：
        <input type="date" id="selectDate">
      </label>
      <label>選擇店家：
        <select id="selectStore"></select>
      </label>
      <button class="action-btn" onclick="addOrderSection()">加入</button>
    </div>

    <div id="orders"></div>
  </div>

<script>
let storeList = [];
let menuData = {};

async function loadStores() {
  const res = await fetch("menu.json");
  menuData = await res.json();
  storeList = Object.keys(menuData);
  const sel = document.getElementById("selectStore");
  sel.innerHTML = "<option value=''>請選擇</option>" +
    storeList.map(s => `<option value='${s}'>${s}</option>`).join("");
}

function addOrderSection() {
  const date = document.getElementById("selectDate").value;
  const store = document.getElementById("selectStore").value;
  if (!date || !store) return alert("請選擇日期與店家");
  if (document.getElementById("section_" + date)) {
    alert("此日期已存在");
    return;
  }

  const section = document.createElement("div");
  section.className = "section";
  section.id = "section_" + date;
  section.innerHTML = `<h4>${date}：${store}</h4>
    <div id="menu_${date}"></div>
    <div id="stats_${date}"></div>`;
  document.getElementById("orders").appendChild(section);

  renderMenu(date, store);
  renderStats(date);
}

function renderMenu(date, store) {
  const menuDiv = document.getElementById("menu_" + date);
  const menu = menuData[store];
  let html = "<table><tr><th>品項</th><th>價格</th><th>數量</th></tr>";
  const savedData = loadLocal(date);

  for (let item in menu) {
    const price = menu[item];
    if (typeof price === "object") {
      for (let sub in price) {
        const key = `${item}-${sub}`;
        const qty = savedData[key]?.qty || 0;
        html += `<tr><td>${item}（${sub}）</td><td>${price[sub]}</td>
          <td><input type='number' min='0' value='${qty}' onchange='updateLocal("${date}", "${key}", ${price[sub]}, this.value)'></td></tr>`;
      }
    } else {
      const qty = savedData[item]?.qty || 0;
      html += `<tr><td>${item}</td><td>${price}</td>
        <td><input type='number' min='0' value='${qty}' onchange='updateLocal("${date}", "${item}", ${price}, this.value)'></td></tr>`;
    }
  }

  html += "</table>";
  menuDiv.innerHTML = html;
}

function updateLocal(date, item, price, qty) {
  let data = loadLocal(date);
  if (parseInt(qty) > 0) {
    data[item] = { price, qty: parseInt(qty) };
  } else {
    delete data[item];
  }
  localStorage.setItem("bento_" + date, JSON.stringify(data));
  renderStats(date);
}

function renderStats(date) {
  const data = loadLocal(date);
  const statsDiv = document.getElementById("stats_" + date);
  if (!data || Object.keys(data).length === 0) {
    statsDiv.innerHTML = "尚無資料";
    return;
  }

  let total = 0;
  let table = "<table><tr><th>品項</th><th>數量</th><th>單價</th><th>小計</th></tr>";
  for (let item in data) {
    const { price, qty } = data[item];
    const subtotal = qty * price;
    total += subtotal;
    table += `<tr><td>${item}</td><td>${qty}</td><td>$${price}</td><td>$${subtotal}</td></tr>`;
  }
  table += `<tr><td colspan='4'>總金額：$${total}</td></tr></table>
    <button class="action-btn" onclick='printSection("stats_${date}")'>列印統計表</button>`;
  statsDiv.innerHTML = table;
}

function loadLocal(date) {
  const json = localStorage.getItem("bento_" + date);
  return json ? JSON.parse(json) : {};
}

function printSection(id) {
  const section = document.getElementById(id).parentElement;
  const inputs = section.querySelectorAll("input, button, select");
  inputs.forEach(el => el.style.display = "none");
  const win = window.open("", "", "width=800,height=600");
  win.document.write("<html><head><title>列印統計表</title>");
  win.document.write("<style>body{font-family:sans-serif;}table,th,td{border:1px solid #ccc;border-collapse:collapse;padding:4px 8px;}th{background:#eee;}</style>");
  win.document.write("</head><body>");
  win.document.write(section.innerHTML);
  win.document.write("</body></html>");
  win.document.close();
  win.onload = () => {
    win.print();
    win.onafterprint = () => win.close();
    inputs.forEach(el => el.style.display = "");
  };
}

loadStores();
</script>
</body>
</html>