<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>便當點餐系統</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<style>
  body {
    font-family: sans-serif;
    color: #000;
    margin: 0 auto;
    padding: 1em;
    background: url('https://raw.githubusercontent.com/polo1364/order/refs/heads/main/FB5BBC50-D21A-4F57-AF32-ABE798E3ABA1.png') repeat;
    background-size: 200px 200px;
  }
  #reminder, #orders, .section {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 4px;
    padding: 1em;
    margin: 0 auto 1em;
    max-width: 800px;
  }
  h2 { color: #b30000; margin-bottom: 0.5em; text-align: center; }
  table { width: 100%; border-collapse: collapse; margin: 0 auto; }
  th, td { border: 1px solid #ccc; padding: 4px 8px; background: rgba(255, 255, 255, 0.95); }
  th { background: #eee; }
  .action-btn { margin: 2px; }
  @media print {
    html, body { background: #fff !important; }
    button, input, select { display: none !important; }
    .section { page-break-after: always; }
  }
  @media (max-width: 600px) {
    body { padding: 0.5em; }
    table, th, td { font-size: 14px; }
  }
</style>
</head>
<body>

<h2>便當點餐系統</h2>

<div id="reminder">
  <h3>本週便當</h3>
  <div id="thisWeekSelects"></div>
  <h3>下週便當（可編輯）</h3>
  <div id="nextWeekSelects"></div>
  <button class="action-btn" onclick="saveNextWeekReminder()">儲存提醒設定</button>
</div>

<div id="orders"></div>

<script>
const firebaseConfig = { databaseURL: "https://bento-5bb36-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let storeList = [];
let thisWeekReminder = {};
let nextWeekReminder = {};
let menuData = {};

// ⭐️ 取得下週一
function getNextMonday() {
  const today = new Date();
  const day = today.getDay() || 7; // 0 (日) -> 7
  const nextMonday = new Date(today);
  nextMonday.setDate(today.getDate() + (8 - day));
  nextMonday.setHours(0, 0, 0, 0);
  return nextMonday;
}

async function loadStores() {
  const res = await fetch("menu.json");
  menuData = await res.json();
  storeList = Object.keys(menuData);
}

async function loadReminder() {
  const snapThis = await db.ref('reminder/thisWeek').once('value');
  thisWeekReminder = snapThis.val() || {};
  const snapNext = await db.ref('reminder/nextWeek').once('value');
  nextWeekReminder = snapNext.val() || {};
  renderReminder();
}

function renderReminder() {
  const weekDays = ["一", "二", "三", "四", "五", "六", "日"];
  let htmlThis = "", htmlNext = "";
  weekDays.forEach(d => {
    htmlThis += `<div>星期${d}：<select disabled><option>${thisWeekReminder[d] || "未設定"}</option></select></div>`;
    htmlNext += `<div ${d==="六"||d==="日"?'style="display:none;"':''}>星期${d}：
      <select id="dayNext_${d}">
        <option value="">請選擇</option>
        ${storeList.map(s => `<option value="${s}" ${nextWeekReminder[d]===s?"selected":""}>${s}</option>`).join("")}
      </select></div>`;
  });
  document.getElementById('thisWeekSelects').innerHTML = htmlThis;
  document.getElementById('nextWeekSelects').innerHTML = htmlNext;
}

function saveNextWeekReminder() {
  const weekDays = ["一", "二", "三", "四", "五", "六", "日"];
  const newReminder = {};
  weekDays.forEach(d => {
    const el = document.getElementById(`dayNext_${d}`);
    if (el) newReminder[d] = el.value;
  });
  db.ref('reminder/nextWeek').set(newReminder);
  nextWeekReminder = newReminder;
  alert("已儲存下週提醒設定！");
  renderOrders();
}

async function renderOrders() {
  document.getElementById('orders').innerHTML = '';
  const weekDays = ["一", "二", "三", "四", "五", "六", "日"];
  const nextMonday = getNextMonday();

  for (let i = 0; i < 7; i++) {
    const date = new Date(nextMonday);
    date.setDate(nextMonday.getDate() + i);
    const yyyyMMdd = date.toISOString().split('T')[0];
    const d = weekDays[date.getDay() || 7];
    if (d === "六" || d === "日") continue; // ⭐️ 不顯示六日

    const store = nextWeekReminder[d] || "未設定";
    if (store === "未設定") continue;

    const section = document.createElement('div');
    section.className = 'section';
    section.innerHTML = `<h4>${yyyyMMdd}（星期${d}）：${store}
      <button class="action-btn" onclick="toggleMenu('${yyyyMMdd}')">顯示/隱藏菜單</button></h4>
      <div id="menu_${yyyyMMdd}" style="display:none;"></div>
      <div id="stats_${yyyyMMdd}"></div>`;
    document.getElementById('orders').appendChild(section);

    // ⭐️ 生成菜單
    const menuDiv = document.getElementById(`menu_${yyyyMMdd}`);
    let html = "<table><tr><th>品項</th><th>價格</th><th>備註</th><th>選取</th></tr>";
    const menu = menuData[store];
    for (let item in menu) {
      const price = menu[item];
      if (typeof price === 'object') {
        for (let sub in price) {
          html += `<tr><td>${item}（${sub}）</td><td>${price[sub]}</td>
            <td><input type='text' placeholder='備註'></td>
            <td><input type='radio' name='menu_${yyyyMMdd}' value='${item}-${sub}' data-price='${price[sub]}'></td></tr>`;
        }
      } else {
        html += `<tr><td>${item}</td><td>${price}</td>
          <td><input type='text' placeholder='備註'></td>
          <td><input type='radio' name='menu_${yyyyMMdd}' value='${item}' data-price='${price}'></td></tr>`;
      }
    }
    html += `<tr><td colspan="4"><input type="text" id="user_${yyyyMMdd}" placeholder="輸入姓名/工號">
      <button class="action-btn" onclick='submitOrder("${yyyyMMdd}","${store}")'>送出</button></td></tr></table>`;
    menuDiv.innerHTML = html;

    db.ref('orders/' + yyyyMMdd).on('value', snap => {
      const data = snap.val();
      const statsDiv = document.getElementById(`stats_${yyyyMMdd}`);
      if (!data) { statsDiv.innerHTML = '尚無資料'; return; }

      let table = "<table><tr><th>品項</th><th>人員</th><th>數量</th><th>單價</th><th>小計</th></tr>";
      let total = 0, paidTotal = 0, unpaidTotal = 0;
      const byItem = {};
      for (let id in data) {
        const { user, item, price, note="", paid=false } = data[id];
        const [itemName, size] = item.split("-");
        const displayItem = size ? `${itemName}（${size}）` : itemName;
        if (!byItem[displayItem]) byItem[displayItem] = [];
        byItem[displayItem].push({ user, id, price: parseInt(price), note, paid });
      }
      for (let item in byItem) {
        const users = byItem[item];
        const unitPrice = users[0].price;
        const itemCount = users.length;
        let itemTotal = 0;

        const noteMap = {};
        users.forEach(u => {
          const key = u.note || "（無備註）";
          if (!noteMap[key]) noteMap[key] = {};
          if (!noteMap[key][u.user]) noteMap[key][u.user] = { ...u, count: 0 };
          noteMap[key][u.user].count++;
          itemTotal += u.price;
          if (u.paid) paidTotal += u.price;
          else unpaidTotal += u.price;
        });
        total += itemTotal;

        const sortedNotes = Object.keys(noteMap).sort(a => a==="（無備註）"?1:-1);
        const userCells = sortedNotes.map(note => {
          const list = Object.values(noteMap[note]).map(u => {
            const c = u.count>1?`（共${u.count}份）`:"";
            const paidCk = `<input type='checkbox' ${u.paid?"checked":""} onclick='togglePaid("${yyyyMMdd}","${u.id}", this.checked)'>`;
            const delBtn = `<button class="action-btn" onclick='deleteOrder("${yyyyMMdd}","${u.id}")'>刪除</button>`;
            return `${u.user}${c} ${paidCk} ${delBtn}`;
          });
          return note==="（無備註）"?list.join("、"):`【${note}】：${list.join("、")}`;
        }).join("<br>");

        table += `<tr><td>${item}</td><td>${userCells}</td><td>${itemCount}</td><td>$${unitPrice}</td><td>$${itemTotal}</td></tr>`;
      }
      table += `<tr><td colspan="5">總金額：$${total} ｜ 已付款：$${paidTotal} ｜ 未付款：$${unpaidTotal}</td></tr></table>
      <button class="action-btn" onclick='printSection("stats_${yyyyMMdd}")'>列印統計表</button>`;
      statsDiv.innerHTML = table;
    });
  }
}

function toggleMenu(date) {
  const div = document.getElementById(`menu_${date}`);
  div.style.display = div.style.display==="none"? "block":"none";
}
function submitOrder(date, store) {
  const sel = document.querySelector(`input[name='menu_${date}']:checked`);
  const user = document.getElementById(`user_${date}`).value.trim();
  const noteInput = sel? sel.parentNode.previousElementSibling.firstElementChild.value.trim() : "";
  if (!user || !store || !sel) return alert("請填寫所有欄位！");
  const item = sel.value;
  const price = sel.getAttribute('data-price');
  const note = noteInput || "";
  const key = db.ref('orders/'+date).push().key;
  db.ref('orders/'+date+'/'+key).set({ user, item, price, note, store });
  alert("已送出！");
}
function togglePaid(date, id, checked) { db.ref(`orders/${date}/${id}`).update({ paid: checked }); }
function deleteOrder(date, id) { if (confirm("確定刪除？")) db.ref(`orders/${date}/${id}`).remove(); }
function printSection(id) {
  const section = document.getElementById(id).parentElement;
  const interactiveElements = section.querySelectorAll('button, input, select');
  interactiveElements.forEach(el => el.style.display='none');
  const win = window.open('', '', 'width=800,height=600');
  win.document.write('<html><head><title>列印統計表</title><style>body { font-family: sans-serif; } table, th, td { border: 1px solid #ccc; border-collapse: collapse; padding: 4px 8px; }</style></head><body>');
  win.document.write(section.innerHTML);
  win.document.write('</body></html>');
  win.document.close();
  win.onload = () => { win.print(); win.onafterprint = () => { win.close(); interactiveElements.forEach(el => el.style.display=''); }; };
}

(async function() {
  await loadStores();
  await loadReminder();
  await renderOrders();
})();
</script>
</body>
</html>