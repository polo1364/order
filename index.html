<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ä¾¿ç•¶çµ±è¨ˆç³»çµ± - å¤§ç‘ç§‘æŠ€</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; padding: 0; background: #f9f9f9; }
    .container { max-width: 1000px; margin: auto; padding: 1em; }
    .section { background: #fff; padding: 1em; border-radius: 6px; margin-bottom: 1em; box-shadow: 0 0 6px rgba(0,0,0,0.05); }
    h2 { color: #b30000; text-align: center; }
    table, th, td {
      border: 1px solid #ccc;
      border-collapse: collapse;
      padding: 4px 6px;
      text-align: center;
      background: #fff;
    }
    th { background: #eee; }
    input[type=number] { width: 60px; }
    .action-btn { margin-top: 10px; padding: 6px 10px; }
    .print-footer {
      display: none;
      margin-top: 40px;
      font-size: 20px;
      line-height: 1.8;
      text-align: center;
    }
    @media print {
      .menu-table, input, button, select, .section label { display: none !important; }
      .print-footer { display: block !important; }
      html, body {
        margin: 0;
        padding: 0;
        width: 210mm;
        height: 297mm;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ä¾¿ç•¶é»é¤ç³»çµ±ï¼ˆå¤§ç‘ç§‘æŠ€ï¼‰</h2>

    <div class="section">
      <label>é¸æ“‡åº—å®¶ï¼š
        <select id="selectStore" onchange="loadStoreMenu()"></select>
      </label>
    </div>

    <div id="orders" class="section" style="display:none;">
      <div class="menu-table" id="menuArea"></div>
      <div id="statsArea"></div>
    </div>
  </div>

  <div class="print-footer">
    <div>å¤§ç‘ç§‘æŠ€</div>
    <div>åœ°å€:é«˜é›„å¸‚å¤§å¯®å€é³³æ—äºŒè·¯532è™Ÿ</div>
    <div>é›»è©±:(07)7871875</div>
  </div>

<script>
let menuData = {};
let currentStore = "";
let currentAddonPrice = { rice: 0, noodle: 0, spicy: 0, bigBowl: 0 };
let hideBigBowl = false;

async function loadStores() {
  const res = await fetch("menu.json");
  menuData = await res.json();
  const storeList = Object.keys(menuData);
  const sel = document.getElementById("selectStore");
  sel.innerHTML = "<option value=''>è«‹é¸æ“‡</option>" +
    storeList.map(s => `<option value='${s}'>${s}</option>`).join("");
}

function loadStoreMenu() {
  const store = document.getElementById("selectStore").value;
  if (!store) return;
  currentStore = store;
  currentAddonPrice = menuData[store].addonPrice || { rice: 0, noodle: 0, spicy: 0, bigBowl: 0 };
  hideBigBowl = menuData[store].hideBigBowl === true;
  document.getElementById("orders").style.display = "block";
  renderMenu();
  renderStats();
}

function renderMenu() {
  const menuDiv = document.getElementById("menuArea");
  const menu = menuData[currentStore].menu;
  let data = loadLocal();
  let html = "<table><tr><th>å“é …</th><th>åƒ¹æ ¼</th><th>æ•¸é‡</th><th>åŠ é£¯</th><th>åŠ éºµ</th><th>åŠ è¾£</th>";
  if (!hideBigBowl) html += "<th>å¤§ç¢—</th>";
  html += "</tr>";

  for (let item in menu) {
    const price = menu[item];

    // å–®ä¸€åƒ¹æ ¼
    if (typeof price === "number") {
      const key = item;
      const entry = data[key] || { qty: 0, rice: 0, noodle: 0, spicy: 0, bigBowl: 0, price: price };
      html += renderRow(key, item, price, entry);
    }

    // è¤‡åˆåƒ¹æ ¼ï¼ˆå¦‚ï¼šå°/å¤§ï¼‰
    else if (typeof price === "object") {
      for (let sub in price) {
        const subKey = `${item} - ${sub}`;
        const subPrice = price[sub];
        const entry = data[subKey] || { qty: 0, rice: 0, noodle: 0, spicy: 0, bigBowl: 0, price: subPrice };
        html += renderRow(subKey, `${item}ï¼ˆ${sub}ï¼‰`, subPrice, entry);
      }
    }
  }

  html += "</table>";
  menuDiv.innerHTML = html;
}

function renderRow(key, label, price, entry) {
  return `<tr>
    <td>${label}</td>
    <td>${price}</td>
    <td><input type='number' min='0' value='${entry.qty}' onchange='update("${key}", ${price})' id='qty_${key}'></td>
    <td><input type='number' min='0' value='${entry.rice}' onchange='update("${key}", ${price})' id='rice_${key}'></td>
    <td><input type='number' min='0' value='${entry.noodle}' onchange='update("${key}", ${price})' id='noodle_${key}'></td>
    <td><input type='number' min='0' value='${entry.spicy}' onchange='update("${key}", ${price})' id='spicy_${key}'></td>
    ${(!hideBigBowl && isSoupNoodle(label)) ? `<td><input type='number' min='0' value='${entry.bigBowl || 0}' onchange='update("${key}", ${price})' id='bigBowl_${key}'></td>` : "<td></td>"}
  </tr>`;
}

function update(key, price) {
  const qty = parseInt(document.getElementById(`qty_${key}`).value) || 0;
  const rice = parseInt(document.getElementById(`rice_${key}`).value) || 0;
  const noodle = parseInt(document.getElementById(`noodle_${key}`).value) || 0;
  const spicy = parseInt(document.getElementById(`spicy_${key}`).value) || 0;
  const bigBowl = hideBigBowl ? 0 : parseInt(document.getElementById(`bigBowl_${key}`)?.value || 0);

  let data = loadLocal();

  if (qty === 0 && rice === 0 && noodle === 0 && spicy === 0 && bigBowl === 0) {
    delete data[key];
  } else {
    data[key] = { qty, rice, noodle, spicy, bigBowl, price };
  }

  localStorage.setItem("bento_data", JSON.stringify(data));
  renderStats();
}

function isSoupNoodle(itemName) {
  const list = menuData[currentStore]?.soupOnlyBigBowl || [];
  const mainName = itemName.split(" - ")[0];  // ç§»é™¤ - å¤§ã€å° ç­‰ä¿®é£¾
  return list.includes(mainName);
}
  
function renderStats() {
  const data = loadLocal();
  const statsDiv = document.getElementById("statsArea");
  if (!data || Object.keys(data).length === 0) {
    statsDiv.innerHTML = "å°šç„¡è³‡æ–™";
    return;
  }

  let total = 0;
  let table = "<table><tr><th>å“é …</th><th>æ•¸é‡</th><th>åŠ é£¯</th><th>åŠ éºµ</th><th>åŠ è¾£</th><th>å¤§ç¢—</th><th>å–®åƒ¹</th><th>å°è¨ˆ</th></tr>";

  for (let item in data) {
    const { price, qty, rice, noodle, spicy, bigBowl = 0 } = data[item];
    const riceCost = rice * (currentAddonPrice.rice || 0);
    const noodleCost = noodle * (currentAddonPrice.noodle || 0);
    const spicyCost = spicy * (currentAddonPrice.spicy || 0);
    
    // ğŸ”§ ä¿®æ­£å¤§ç¢—é‡‘é¡å®‰å…¨åˆ¤æ–·ï¼ˆé¿å… NaNï¼‰
    let bigBowlCost = 0;
if (isSoupNoodle(item) && !isNaN(currentAddonPrice.bigBowl)) {
  bigBowlCost = bigBowl * currentAddonPrice.bigBowl;
}

    const itemSubtotal = qty * price + riceCost + noodleCost + spicyCost + bigBowlCost;
    total += itemSubtotal;

    table += `<tr>
      <td>${item}</td>
      <td>${qty}</td>
      <td>${rice}ï¼ˆ$${riceCost}ï¼‰</td>
      <td>${noodle}ï¼ˆ$${noodleCost}ï¼‰</td>
      <td>${spicy}ï¼ˆ$${spicyCost}ï¼‰</td>
      <td>${bigBowl}ï¼ˆ$${bigBowlCost}ï¼‰</td>
      <td>$${price}</td>
      <td>$${itemSubtotal}</td>
    </tr>`;
  }

  table += `<tr><td colspan='8'>ç¸½é‡‘é¡ï¼š$${total}</td></tr></table>
    <button class="action-btn" onclick='printStats()'>åˆ—å°çµ±è¨ˆè¡¨</button>`;
  statsDiv.innerHTML = table;
}

function loadLocal() {
  const json = localStorage.getItem("bento_data");
  return json ? JSON.parse(json) : {};
}

function printStats() {
  window.print();
}

loadStores();
</script>
</body>
</html>
