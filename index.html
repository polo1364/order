<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>便當統計表 - 大瑞科技</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      background: #fdfdfd;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1000px;
      margin: auto;
      padding: 1em;
    }
    .section {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 1em;
      margin-bottom: 1em;
    }
    h2 {
      color: #b30000;
      text-align: center;
    }
    table, th, td {
      border: 1px solid #ccc;
      border-collapse: collapse;
      padding: 4px 6px;
      background: #fff;
      text-align: center;
    }
    th { background: #eee; }
    input[type=number] {
      width: 60px;
    }
    .action-btn {
      margin-top: 10px;
      padding: 6px 10px;
    }
    .menu-table { display: block; }
    .print-footer {
      display: none;
      margin-top: 40px;
      font-size: 20px;
      line-height: 1.8;
      text-align: center;
    }
    @media print {
      .menu-table, input, button, select, .section label { display: none !important; }
      .print-footer { display: block !important; }
      html, body {
        margin: 0;
        padding: 0;
        width: 210mm;
        height: 297mm;
      }
      body {
        zoom: 100%;
        -webkit-print-color-adjust: exact;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>便當點餐系統（大瑞科技）</h2>

    <div class="section">
      <label>選擇店家：
        <select id="selectStore" onchange="loadStoreMenu()"></select>
      </label>
    </div>

    <div id="orders" class="section" style="display:none;">
      <div class="menu-table" id="menuArea"></div>
      <div id="statsArea"></div>
    </div>
  </div>

  <div class="print-footer">
    <div>大瑞科技</div>
    <div>地址:高雄市大寮區鳳林二路532號</div>
    <div>電話:(07)7871875</div>
  </div>

<script>
window.addEventListener('load', () => {
  localStorage.removeItem("bento_data");
});

let menuData = {};
let currentStore = "";

async function loadStores() {
  const res = await fetch("menu.json");
  menuData = await res.json();
  const storeList = Object.keys(menuData);
  const sel = document.getElementById("selectStore");
  sel.innerHTML = "<option value=''>請選擇</option>" +
    storeList.map(s => `<option value='${s}'>${s}</option>`).join("");
}

function loadStoreMenu() {
  const store = document.getElementById("selectStore").value;
  if (!store) return;
  currentStore = store;
  document.getElementById("orders").style.display = "block";
  renderMenu();
  renderStats();
}

function renderMenu() {
  const menuDiv = document.getElementById("menuArea");
  const menu = menuData[currentStore];
  let data = loadLocal();
  let html = "<table><tr><th>品項</th><th>價格</th><th>數量</th><th>加飯</th><th>加麵</th><th>加辣</th></tr>";

  for (let item in menu) {
    const price = menu[item];
    if (typeof price === "object") {
      for (let sub in price) {
        const baseName = `${item}（${sub}）`;
        const key = baseName;
        const entry = data[key] || {};
        html += `<tr><td>${baseName}</td><td>${price[sub]}</td>
          <td><input type='number' min='0' value='${entry.qty || 0}' onchange='update("${key}", ${price[sub]})' id='qty_${key}'></td>
          <td><input type='checkbox' ${entry.rice ? "checked" : ""} onchange='update("${key}", ${price[sub]})' id='rice_${key}'></td>
          <td><input type='checkbox' ${entry.noodle ? "checked" : ""} onchange='update("${key}", ${price[sub]})' id='noodle_${key}'></td>
          <td><input type='checkbox' ${entry.spicy ? "checked" : ""} onchange='update("${key}", ${price[sub]})' id='spicy_${key}'></td>
          </tr>`;
      }
    } else {
      const key = item;
      const entry = data[key] || {};
      html += `<tr><td>${item}</td><td>${price}</td>
        <td><input type='number' min='0' value='${entry.qty || 0}' onchange='update("${key}", ${price})' id='qty_${key}'></td>
        <td><input type='checkbox' ${entry.rice ? "checked" : ""} onchange='update("${key}", ${price})' id='rice_${key}'></td>
        <td><input type='checkbox' ${entry.noodle ? "checked" : ""} onchange='update("${key}", ${price})' id='noodle_${key}'></td>
        <td><input type='checkbox' ${entry.spicy ? "checked" : ""} onchange='update("${key}", ${price})' id='spicy_${key}'></td>
        </tr>`;
    }
  }

  html += "</table>";
  menuDiv.innerHTML = html;
}

function update(key, price) {
  const qty = parseInt(document.getElementById(`qty_${key}`).value) || 0;
  const rice = document.getElementById(`rice_${key}`).checked;
  const noodle = document.getElementById(`noodle_${key}`).checked;
  const spicy = document.getElementById(`spicy_${key}`).checked;
  let data = loadLocal();

  if (qty === 0) {
    for (let k in data) {
      if (k.startsWith(key + "｜")) {
        delete data[k];
      }
    }
  } else {
    const additions = [];
    if (rice) additions.push("加飯");
    if (noodle) additions.push("加麵");
    if (spicy) additions.push("加辣");
    const displayName = additions.length ? `${key}（${additions.join("、")}）` : key;
    data[displayName] = { qty, price };
  }

  localStorage.setItem("bento_data", JSON.stringify(data));
  renderStats();
}

function renderStats() {
  const data = loadLocal();
  const statsDiv = document.getElementById("statsArea");
  if (!data || Object.keys(data).length === 0) {
    statsDiv.innerHTML = "尚無資料";
    return;
  }

  let total = 0;
  let table = "<table><tr><th>品項</th><th>數量</th><th>單價</th><th>小計</th></tr>";
  for (let item in data) {
    const { price, qty } = data[item];
    const subtotal = qty * price;
    total += subtotal;
    table += `<tr><td>${item}</td><td>${qty}</td><td>$${price}</td><td>$${subtotal}</td></tr>`;
  }
  table += `<tr><td colspan='4'>總金額：$${total}</td></tr></table>
    <button class="action-btn" onclick='printStats()'>列印統計表</button>`;
  statsDiv.innerHTML = table;
}

function loadLocal() {
  const json = localStorage.getItem("bento_data");
  return json ? JSON.parse(json) : {};
}

function printStats() {
  window.print();
}

loadStores();
</script>
</body>
</html>