<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>ä¾¿ç•¶é»é¤ç³»çµ±</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<style>
  body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 1em; background: #f9f9f9; }
  h2 { color: #b30000; margin-bottom: 0.5em; }
  table, th, td { border: 1px solid #ccc; border-collapse: collapse; padding: 4px 8px; background: #fff; }
  th { background: #eee; }
  .hidden { display: none; }
  @media print {
    html, body { margin: 0; padding: 0; }
    #loginSection, #controls, #menuArea, h2, #main p, #storeSelect, #orderDate, button:not(.print-btn) { display: none !important; }
    #stats { margin: 0 auto; width: 100%; font-size: 12pt; }
    table { width: 100%; table-layout: fixed; }
    th, td { padding: 6px; text-align: left; }
  }
</style>
</head>
<body>

<h2>ä¾¿ç•¶é»é¤ç³»çµ±</h2>

<div id="loginSection">
  å·¥è™Ÿï¼š<input id="userId" />
  <button onclick="login()">ç™»å…¥</button>
</div>

<div id="main" class="hidden">
  <p>ä½¿ç”¨è€…ï¼š<span id="userName"></span></p>

  <label>åº—å®¶ï¼š
    <select id="storeSelect" onchange="loadMenu()">
      <option value="">è«‹é¸æ“‡</option>
    </select>
  </label>

  <div id="menuArea"></div>
  <div id="dateArea" class="hidden">
    <input type="date" id="orderDate" />
    <button onclick="submitOrder()">é€å‡º</button>
  </div>
</div>

<h3>äººæ•¸çµ±è¨ˆ</h3>
<div id="stats"></div>

<script>
// Firebase åˆå§‹åŒ–
const firebaseConfig = {
  databaseURL: "https://bento-5bb36-default-rtdb.firebaseio.com/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let user = "";
let menuData = {};

// è¼‰å…¥åº—å®¶æ¸…å–®
window.onload = async function() {
  try {
    const res = await fetch("https://polo1364.github.io/order/menu.json");
    const data = await res.json();
    const storeSelect = document.getElementById('storeSelect');
    for (let store in data) {
      const opt = document.createElement('option');
      opt.value = store;
      opt.textContent = store;
      storeSelect.appendChild(opt);
    }
  } catch {
    alert("ç„¡æ³•è¼‰å…¥åº—å®¶æ¸…å–®ï¼Œè«‹ç¨å¾Œå†è©¦ï¼");
  }
};

function login() {
  user = document.getElementById('userId').value.trim();
  if (!user) return alert("è«‹è¼¸å…¥å·¥è™Ÿï¼");
  document.getElementById('main').classList.remove('hidden');
  document.getElementById('userName').innerText = user;
}

async function loadMenu() {
  const store = document.getElementById('storeSelect').value;
  const menuArea = document.getElementById('menuArea');
  const dateArea = document.getElementById('dateArea');
  menuArea.innerHTML = "";
  dateArea.classList.add('hidden');
  if (!store) return;

  try {
    const res = await fetch("https://polo1364.github.io/order/menu.json");
    const data = await res.json();
    menuData = data[store];
    if (!menuData) throw new Error("èœå–®è¼‰å…¥å¤±æ•—");

    let html = "<table><tr><th>å“é …</th><th>åƒ¹æ ¼</th><th>å‚™è¨»</th><th>é¸å–</th></tr>";
    for (let item in menuData) {
      const price = menuData[item];
      if (typeof price === 'object') {
        for (let sub in price) {
          html += `<tr><td>${item}ï¼ˆ${sub}ï¼‰</td><td>${price[sub]}</td>
          <td><input type='text' placeholder='å‚™è¨»' data-item='${item}-${sub}'></td>
          <td><input type='radio' name='menuItem' value='${item}-${sub}' data-price='${price[sub]}'></td></tr>`;
        }
      } else {
        html += `<tr><td>${item}</td><td>${price}</td>
        <td><input type='text' placeholder='å‚™è¨»' data-item='${item}'></td>
        <td><input type='radio' name='menuItem' value='${item}' data-price='${price}'></td></tr>`;
      }
    }
    html += "</table>";
    menuArea.innerHTML = html;
    dateArea.classList.remove('hidden');
  } catch {
    alert("ç„¡æ³•è¼‰å…¥èœå–®ï¼Œè«‹ç¨å¾Œå†è©¦ï¼");
  }
}

function submitOrder() {
  const date = document.getElementById('orderDate').value;
  const store = document.getElementById('storeSelect').value;
  const sel = document.querySelector("input[name='menuItem']:checked");
  const noteInput = sel ? sel.parentNode.previousElementSibling.firstElementChild.value.trim() : "";

  if (!user || !date || !store || !sel) return alert("è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½");

  const item = sel.value;
  const price = sel.getAttribute('data-price');
  const note = noteInput || "";

  const key = db.ref('orders/' + date).push().key;
  db.ref('orders/' + date + '/' + key).set({ user, item, price, note, store });  // âœ…æŠŠã€Œstoreã€ä¸€ä½µå­˜é€²å»
}

// ç›£è½çµ±è¨ˆè¡¨
db.ref('orders').on('value', snapshot => {
  const stats = document.getElementById('stats');
  stats.innerHTML = '';
  const data = snapshot.val();
  if (!data) return stats.innerHTML = 'å°šç„¡è³‡æ–™';

  const today = new Date();

  for (let date in data) {
    const dateObj = new Date(date);
    const diffTime = today - dateObj;
    const diffDays = diffTime / (1000 * 60 * 60 * 24);

    if (diffDays > 3) {
      db.ref(`orders/${date}`).remove().then(() => {
        console.log(`å·²åˆªé™¤ ${date} çš„çµ±è¨ˆè¡¨`);
      }).catch(err => {
        console.error(`åˆªé™¤ ${date} å¤±æ•—ï¼š`, err);
      });
      continue;
    }

    // ğŸ”¥ åŒä¸€å¤©ä¾ã€Œåº—å®¶ã€åˆ†ç¾¤
    const byStore = {};
    for (let id in data[date]) {
      const { store, user: u, item, price, note } = data[date][id];
      if (!byStore[store]) byStore[store] = {};
      const key = note ? `${item}__${note}` : `${item}__`;
      if (!byStore[store][key]) byStore[store][key] = [];
      byStore[store][key].push({ user: u, id, price, note });
    }

    // ğŸ”¥ ä¾ã€Œåº—å®¶ã€å»ºç«‹å¤šå€‹çµ±è¨ˆè¡¨
    for (let store in byStore) {
      const div = document.createElement('div');

      // å–å¾—æ˜ŸæœŸå¹¾
      const weekday = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
      const weekdayStr = `æ˜ŸæœŸ${weekday[dateObj.getDay()]}`;
      div.innerHTML = `<h4>${date}ï¼ˆ${weekdayStr}ï¼‰ - ${store}</h4>`;

      const table = document.createElement('table');
      table.innerHTML = "<tr><th>å“é …</th><th>äººå“¡</th><th>æ•¸é‡</th></tr>";

      let total = 0;
      for (let key in byStore[store]) {
        const users = byStore[store][key];
        total += users.length * users[0].price;

        const [item, note] = key.split('__');

        // çµ±è¨ˆåŒäººå¤šæ¬¡é»é¤ & ä¸åŒå‚™è¨»ä¹Ÿè¦–ç‚ºä¸åŒ
        const userCount = {};
        users.forEach(u => {
          if (!userCount[u.user]) userCount[u.user] = { count: 0, ids: [], notes: [] };
          userCount[u.user].count++;
          if (u.user === user) userCount[u.user].ids.push(u.id);
          if (u.note) userCount[u.user].notes.push(u.note);
        });

        const names = Object.entries(userCount).map(([name, obj]) => {
          const noteText = obj.notes.length > 0 ? `ï¼ˆ${obj.notes.join("ã€")}ï¼‰` : "";
          const delBtn = (obj.ids.length > 0) ?
            `<button class='delete-btn' onclick='deleteRecord("${date}","${obj.ids[0]}")'>åˆªé™¤</button>` : "";
          return obj.count > 1 ? `${name}${noteText}ï¼ˆå…±${obj.count}ä»½ï¼‰ ${delBtn}` : `${name}${noteText} ${delBtn}`;
        });

        const noteText = note ? `ï¼ˆ${note}ï¼‰` : "";
        table.innerHTML += `<tr>
          <td>${item}</td>
          <td>${names.join("ã€")}${noteText}</td>
          <td>${users.length}</td>
        </tr>`;
      }

      table.innerHTML += `<tr><td colspan="2">ç¸½é‡‘é¡</td><td>$${total}</td></tr>`;
      div.appendChild(table);

      // ã€Œåªåˆ—å°é€™å¼µã€æŒ‰éˆ•
      const printBtn = document.createElement('button');
      printBtn.classList.add('print-btn');
      printBtn.innerText = `åˆ—å° ${date} - ${store} çµ±è¨ˆè¡¨`;
      printBtn.onclick = () => printSection(div);
      div.appendChild(printBtn);

      stats.appendChild(div);
    }
  }
});

function deleteRecord(date, id) {
  if (!confirm("ç¢ºå®šè¦åˆªé™¤ï¼Ÿ")) return;
  db.ref(`orders/${date}/${id}`).remove().then(() => alert("å·²åˆªé™¤ï¼"))
    .catch(err => alert(`åˆªé™¤å¤±æ•—ï¼š${err}`));
}

function printSection(section) {
  const printWindow = window.open('', '', 'width=800,height=600');
  printWindow.document.write('<html><head><title>åˆ—å°çµ±è¨ˆè¡¨</title>');
  printWindow.document.write('<style>table, th, td { border: 1px solid #ccc; border-collapse: collapse; padding: 4px 8px; }</style>');
  printWindow.document.write('</head><body>');
  printWindow.document.write(section.innerHTML);
  printWindow.document.write('</body></html>');
  printWindow.document.close();
  printWindow.print();
}
</script>

</body>
</html>